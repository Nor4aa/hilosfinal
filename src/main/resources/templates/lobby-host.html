<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Sala Host</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-dark text-white">
    <div class="container mt-4 text-center">
        <h1>PIN DE LA SALA: <span th:text="${pin}" class="display-3 text-warning">0000</span></h1>
        
        <div id="game-area" class="mt-5">
            <button id="btn-start" class="btn btn-lg btn-success">INICIAR JUEGO</button>
            <h3 id="status-msg" class="mt-3">Esperando jugadores...</h3>
        </div>

        <div id="question-area" class="mt-5" style="display:none;">
            <h2 id="q-text">Pregunta...</h2>
            <div class="mt-4">
               <h4 id="timer">Tiempo: --</h4>
            </div>
            
            <div class="mt-5">
                <h4>Ranking en Vivo</h4>
                <ul id="ranking-list" class="list-group text-dark">
                </ul>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var pin = /*[[${pin}]]*/ '0000';
        
        $('#btn-start').click(function() {
            $.post('/game/' + pin + '/start', function(res) {
                if(res === 'OK') {
                    $('#btn-start').hide();
                    $('#status-msg').text('Juego Iniciado!');
                    $('#question-area').show();
                    startPolling();
                }
            });
        });

        function startPolling() {
            setInterval(function() {
                $.get('/game/host/data?pin=' + pin, function(data) {
                    if (data.status === 'FINISHED') {
                        $('#q-text').text("JUEGO FINALIZADO");
                        return;
                    }

                    // Update Question
                    var q = data.question;
                    if (data.isOpen) {
                         $('#q-text').text("P" + (data.questionIndex + 1) + ": " + q.enunciado);
                         $('#timer').text("Â¡RESPONDE AHORA!");
                         $('#timer').css('color', 'green');
                    } else {
                         $('#q-text').text("Tiempo agotado... Esperando siguiente...");
                         $('#timer').text("TIEMPO AGOTADO");
                         $('#timer').css('color', 'red');
                    }

                    // Update Ranking
                    var list = $('#ranking-list');
                    list.empty();
                    $.each(data.ranking, function(player, score) {
                        list.append('<li class="list-group-item">' + player + ': ' + score + ' pts</li>');
                    });
                });
            }, 1000); // 1 second updates
        }
        /*]]>*/
    </script>
</body>
</html>
